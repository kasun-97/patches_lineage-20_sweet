From 56aede2f9496cf55e03287341d658612a15c02af Mon Sep 17 00:00:00 2001
From: Chirayu Desai <chirayudesai1@gmail.com>
Date: Tue, 6 Jul 2021 18:31:54 +0530
Subject: [PATCH 14/15] pm: microg-spoof: Add null check

* Usually happens in work profile without microG

PackageManagerService.MICROG_SPOOF_SIGNATURE: java.lang.NullPointerException: Attempt to write to field 'android.content.pm.Signature[] android.content.pm.PackageInfo.signatures' on a null object reference
PackageManagerService.MICROG_SPOOF_SIGNATURE: 	at com.android.server.pm.PackageManagerService.mayFakeSignature(PackageManagerService.java:4460)

Change-Id: I8e582e18a02ce7a3822eb468cd4a7d576d882f3b
---
 services/core/java/com/android/server/pm/ComputerEngine.java | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/services/core/java/com/android/server/pm/ComputerEngine.java b/services/core/java/com/android/server/pm/ComputerEngine.java
index 9206ec2d5579..63da5916bd9c 100644
--- a/services/core/java/com/android/server/pm/ComputerEngine.java
+++ b/services/core/java/com/android/server/pm/ComputerEngine.java
@@ -1617,7 +1617,9 @@ public class ComputerEngine implements Computer {
                 if (DEBUG_PACKAGE_INFO) {
                     Log.v(TAG, "Spoofing signature for microG");
                 }
-                pi.signatures = new Signature[] {new Signature(MICROG_FAKE_SIGNATURE)};
+                if (pi != null) {
+                    pi.signatures = new Signature[] {new Signature(MICROG_FAKE_SIGNATURE)};
+                }
             }
         } catch (Throwable t) {
             // We should never die because of any failures, this is system code!
-- 
2.25.1

